<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación del Subproyecto de Contratos</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1024px; margin: 20px auto; padding: 0 20px; }
        h1, h2, h3, h4 { color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        h1 { font-size: 2.5em; text-align: center; border-bottom: 4px solid #3498db; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.5em; border-bottom: 1px solid #ecf0f1; }
        h4 { font-size: 1.2em; border-bottom: none; color: #34495e; }
        code { background-color: #ecf0f1; padding: 3px 6px; border-radius: 4px; font-family: "Courier New", Courier, monospace; font-size: 0.9em; }
        pre { background-color: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; text-align: center; }
        pre.mermaid { background-color: #f9f9f9; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .section { margin-bottom: 40px; }
        .placeholder { color: blue; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Documentación del Subproyecto de Contratos</h1>
        <p style="text-align:center;">Este documento se enfoca en el modelo <code>isp.contract</code> y los procesos de negocio asociados.</p>

        <div class="section" id="proposito">
            <h2>1. Propósito y Alcance</h2>
            <p>El subproyecto de <strong>Contratos</strong> es el núcleo funcional que conecta la gestión comercial con la operación técnica del ISP. El modelo <code>isp.contract</code> no es solo un registro administrativo; es una entidad activa que representa un servicio específico para un cliente en una ubicación determinada, y sirve como el punto de partida para todas las operaciones de aprovisionamiento y gestión de servicios en la red.</p>
            <h4>Alcance:</h4>
            <ul>
                <li>Centralizar toda la información de un servicio contratado, desde el cliente y el plan hasta el puerto de la OLT y la IP asignada.</li>
                <li>Orquestar el ciclo de vida completo de un servicio: alta, suspensión, cambio de plan y baja.</li>
                <li>Servir como fuente única de verdad para los sistemas de aprovisionamiento automático.</li>
            </ul>
        </div>

        <div class="section" id="modelo_datos">
            <h2>2. Modelo de Datos del Contrato</h2>
            <h3>2.1. Análisis del Modelo `isp.contract`</h3>
            <p>El modelo <code>isp.contract</code> está compuesto por campos que se pueden agrupar en tres categorías lógicas:</p>
            <table>
                <thead><tr><th>Categoría</th><th>Campos Clave</th><th>Descripción</th></tr></thead>
                <tbody>
                    <tr>
                        <td><strong>Información Comercial</strong></td>
                        <td><code>partner_id</code>, <code>product_id</code>, <code>start_date</code>, <code>state</code></td>
                        <td>Vincula el contrato a un cliente (<code>res.partner</code>) y a un plan de servicio (<code>product.product</code>). El campo <code>state</code> refleja el estado actual del ciclo de vida (Activo, Suspendido, etc.).</td>
                    </tr>
                    <tr>
                        <td><strong>Vinculación Técnica</strong></td>
                        <td><code>olt_id</code>, <code>olt_card_port_id</code>, <code>splitter_id</code>, <code>box_id</code>, <code>ap_id</code>, <code>onu_id</code></td>
                        <td>Esta es la sección más crítica. Estos campos relacionan el contrato directamente con los activos específicos de la infraestructura de red que proveen el servicio.</td>
                    </tr>
                    <tr>
                        <td><strong>Datos de Conexión</strong></td>
                        <td><code>ip_address</code>, <code>mac_address</code>, <code>vlan_id</code>, <code>radius_id</code></td>
                        <td>Almacena los datos lógicos y de autenticación del servicio del cliente, como la dirección IP asignada o el servidor RADIUS que lo gestiona.</td>
                    </tr>
                </tbody>
            </table>

            <h3>2.2. Diagrama de Relaciones del Contrato (ERD)</h3>
            <p>Este diagrama muestra el modelo <code>isp.contract</code> como la entidad central y sus relaciones directas más importantes.</p>
            <pre class="mermaid">
erDiagram
    RES_PARTNER ||--|{ ISP_CONTRACT : "tiene"
    PRODUCT_PRODUCT ||--|{ ISP_CONTRACT : "define el plan de"
    ISP_CONTRACT {
        string name
        int partner_id FK
        int product_id FK
        date start_date
        string state
        int olt_card_port_id FK
        int box_id FK
        string ip_address
    }
    ISP_OLT_CARD_PORT ||--o{ ISP_CONTRACT : "aprovisiona en"
    ISP_BOX ||--o{ ISP_CONTRACT : "conecta en"
    ISP_RADIUS_USER ||..o{ ISP_CONTRACT : "autentica para"
            </pre>
        </div>

        <div class="section" id="ciclo_vida">
            <h2>3. Ciclo de Vida y Procesos de Negocio del Contrato</h2>
            <p>El contrato evoluciona a través de varios estados y procesos. Estos flujos de trabajo son el corazón de la operación del ISP.</p>
            
            <h3>3.1. Diagrama General del Ciclo de Vida</h3>
            <pre class="mermaid">
graph TD
    Borrador --&gt; Activo;
    Activo --&gt; Suspendido;
    Suspendido --&gt; Activo;
    Activo --&gt; Cancelado;
    Suspendido --&gt; Cancelado;
    Activo --&gt; Activo_Cambiado[Activo (Plan Modificado)];

    subgraph Creación
        Borrador
    end
    subgraph Operación Normal
        Activo
        Activo_Cambiado
    end
    subgraph Gestión de Morosidad
        Suspendido
    end
    subgraph Terminación
        Cancelado
    end
            </pre>

            <h3>3.2. Procesos de Negocio Detallados</h3>

            <h4>Activación de un Nuevo Contrato</h4>
            <p>Orquesta el alta de un nuevo servicio, desde la venta hasta la conexión funcional del cliente.</p>
            <pre class="mermaid">
sequenceDiagram
    participant Ventas
    participant Odoo
    participant NetOps as Equipo de Red

    Ventas->>Odoo: Crea Contrato en estado 'Borrador' con plan y cliente.
    Odoo->>Ventas: Solicita validación de factibilidad.
    Ventas->>Odoo: Asigna activos técnicos (caja, puerto, etc.) y confirma.
    Ventas->>Odoo: Cambia estado a 'Activo'.
    Odoo-->>NetOps: Dispara script de aprovisionamiento (OLT, RADIUS, Core).
    NetOps-->>Odoo: Confirma ejecución de scripts.
    Odoo->>Ventas: Notifica que el servicio está técnicamente activo.
            </pre>

            <h4>Suspensión y Reactivación por Morosidad</h4>
            <p>Gestiona el corte y la reconexión del servicio basándose en el estado de pago del cliente.</p>
            <pre class="mermaid">
graph TD
    A(Inicio: Factura impaga) --&gt; B{Contrato en estado 'Activo'};
    B --&gt; C[Odoo cambia estado a 'Suspendido'];
    C --&gt; D{Disparar script de suspensión};
    D --&gt; E[OLT/Router: Deshabilitar puerto/usuario];
    E --&gt; F((Cliente Cortado));
    
    subgraph Reactivación
    G(Pago Registrado en Odoo) --&gt; H{Contrato en estado 'Suspendido'};
    H --&gt; I[Odoo cambia estado a 'Activo'];
    I --&gt; J{Disparar script de reactivación};
    J --&gt; K[OLT/Router: Habilitar puerto/usuario];
    K --&gt; L((Cliente Reconectado));
    end
            </pre>

            <h4>Cambio de Plan (Upgrade/Downgrade)</h4>
            <p>Maneja la modificación de un servicio existente, principalmente ajustando el ancho de banda.</p>
            <pre class="mermaid">
graph TD
    A(Inicio: Solicitud de cambio de plan) --&gt; B{Actualizar `product_id` en el Contrato};
    B --&gt; C{Disparar script de cambio de velocidad};
    C --&gt; D[Router/OLT: Modificar perfil de ancho de banda];
    D --&gt; E((Fin: Plan del cliente actualizado));
    subgraph Facturación
        C --&gt; F[Calcular prorrateo para la facturación];
    end
            </pre>
        </div>

        <div class="section" id="recomendaciones">
            <h2>4. Recomendaciones y Futuro del Subproyecto</h2>
            <p>Basado en el análisis y los estándares de la industria, se proponen las siguientes mejoras:</p>
            <ul>
                <li><strong>Historial de Cambios del Contrato:</strong> Crear un modelo relacionado (<code>isp.contract.history</code>) que registre cada cambio de estado, plan o técnico. Esto es vital para la auditoría y el soporte al cliente.</li>
                <li><strong>Separar Servicio de Contrato:</strong> Para ISPs más complejos, se recomienda separar el "Contrato" (acuerdo comercial) del "Servicio" (instancia técnica). Un contrato podría tener múltiples servicios (ej. Internet + TV). Actualmente están unificados en <code>isp.contract</code>.</li>
                <li><strong>Automatizar Facturación de Cambios:</strong> La lógica para calcular el prorrateo en un cambio de plan debería ser automatizada y crear los apuntes contables correspondientes en Odoo. <span class="placeholder">[COMPLETAR: Definir las reglas de negocio para el prorrateo]</span>.</li>
                <li><strong>Mejorar la Gestión de Estados:</strong> El ciclo de vida podría enriquecerse con más estados, como 'Pendiente de Instalación', 'En Proceso de Baja', para reflejar mejor la realidad operativa.</li>
            </ul>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
</body>
</html>
